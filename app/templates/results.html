<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <title>–°–∏—Å—Ç–µ–º–∞ –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ê–Ω–∞–ª–∏–∑–∞ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è v3.0</title>
    <script src="{{ url_for('static', filename='js/chart.umd.min.js') }}"></script>    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">


</head>
<body>
    <!-- NEW: –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üìä</div>
                    <span class="logo-text">TestAnalytics v3</span>
                </div>
            </div>

            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">–ê–Ω–∞–ª–∏–∑</div>
                    <a class="nav-item active" data-view="dashboard">
                        <span class="nav-item-icon">üè†</span><span class="nav-item-text">–î–∞—à–±–æ—Ä–¥</span>
                    </a>
                    <a class="nav-item" data-view="comparison">
                        <span class="nav-item-icon">üîç</span><span class="nav-item-text">–î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</span>
                    </a>
                    <a class="nav-item" data-view="abandoned">
                        <span class="nav-item-icon">üö´</span><span class="nav-item-text">–ü—Ä–µ—Ä–≤–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏</span>
                    </a>
                    <a class="nav-item" data-view="behavior">
                        <span class="nav-item-icon">üß†</span><span class="nav-item-text">–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–û—Ç—á–µ—Ç—ã</div>
                     <a class="nav-item" data-view="registry">
                        <span class="nav-item-icon">üìú</span><span class="nav-item-text">–†–µ–µ—Å—Ç—Ä –∞—Ç—Ç–µ—Å—Ç–∞—Ç–æ–≤</span>
                    </a>
                    <a class="nav-item" data-view="statistics">
                        <span class="nav-item-icon">üìà</span><span class="nav-item-text">–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="menu-toggle" id="menuToggle">‚ò∞</button>
                    <nav class="breadcrumbs" id="breadcrumbs">
                        </nav>
                </div>
                <div class="top-bar-right">
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" placeholder="–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (Ctrl+K)..." id="globalSearch">
                    </div>
                    <button class="notification-btn" id="notificationBtn">
                        üîî
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
					<div class="user-menu" id="userMenu">
					    <div class="user-avatar">–ê–ò</div>
					    <div class="user-info">
					        <div class="user-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
					        <div class="user-role">–ì–ª–∞–≤–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫</div>
					    </div>
					    <span>‚ñº</span>

					    <div class="user-menu-dropdown">
					        <div class="user-info-header">
					            <div class="user-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
					            <div class="user-role">admin@example.com</div>
					        </div>
        
					        <a href="#" class="dropdown-item" id="openSettingsBtn">
					            <span>‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
					        </a>
        
					        <hr style="border: none; border-top: 1px solid var(--border); margin: 0.5rem 0;">
					        <a href="/logout" class="dropdown-item logout"> 
					            <span>üö™</span> –í—ã—Ö–æ–¥
					        </a>
					    </div>
					    </div>
            </header>

            <div class="content-area">
                <div id="dashboard-view">
                    <div class="dashboard-grid" id="dashboard-widgets">
                        </div>

                    <div class="dashboard-charts-section" style="margin-top: 2rem;">
                        <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
                            <div class="chart-card">
                                <h3 style="margin-bottom: 1rem; color: var(--text);">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</h3>
                                <div style="position: relative; height: 300px;">
                                    <canvas id="dashboardGradesChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3 style="margin-bottom: 1rem; color: var(--text);">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
                                <div style="position: relative; height: 300px;">
                                    <canvas id="dashboardActivityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filters-section">
                        <div class="filters-header">
                            <h2 class="filters-title">–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h2>
								<div class="load-options-dropdown">
									<span class="load-options-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ:</span>
									<button class="dropdown-toggle" id="loadOptionsToggle">
										<span id="selectedValue">20</span>
										<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
											<path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
										</svg>
									</button>
									<div class="dropdown-menu" id="loadOptionsMenu">
										<a href="#" class="dropdown-item" data-count="20">20</a>
										<a href="#" class="dropdown-item" data-count="50">50</a>
										<a href="#" class="dropdown-item" data-count="100">100</a>
										<a href="#" class="dropdown-item" data-count="200">200</a>
										<a href="#" class="dropdown-item" data-count="300">300</a>
										<a href="#" class="dropdown-item" data-count="400">400</a>
										<a href="#" class="dropdown-item" data-count="all">–í—Å–µ</a>
									</div>
								</div>
                            <div class="filter-presets">
                                <button class="preset-btn active" data-preset="all">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                                <button class="preset-btn" data-preset="today">–°–µ–≥–æ–¥–Ω—è</button>
                                <button class="preset-btn" data-preset="week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</button>
                                <button class="preset-btn" data-preset="anomalies">–° –∞–Ω–æ–º–∞–ª–∏—è–º–∏</button>
                            </div>
                        </div>
                        <div class="filters-content">
                            <div class="filter-group">
                                <label for="lastNameFilter" class="filter-label">–§–∞–º–∏–ª–∏—è:</label>
                                <input type="text" id="lastNameFilter" class="filter-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                            </div>
                            <div class="filter-group">
                                <label for="firstNameFilter" class="filter-label">–ò–º—è:</label>
                                <input type="text" id="firstNameFilter" class="filter-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                            </div>
                            <div class="filter-group">
                                <label for="fingerprintFilter" class="filter-label">–ì—Ä—É–ø–ø–∞ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤:</label>
                                <select id="fingerprintFilter" class="filter-select"><option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option></select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">–°—Ç–∞—Ç—É—Å</label>
                                <select id="statusFilter" class="filter-select">
                                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                                    <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                                    <option value="abandoned">–ü—Ä–µ—Ä–≤–∞–Ω</option>
                                </select>
                            </div>
                        </div>
                         <div class="filter-actions">
                            <button class="btn btn-primary" id="analyzeFingerprintBtn">üîê –ê–Ω–∞–ª–∏–∑ Fingerprint</button>
                            <button class="btn btn-primary" id="analyzeMouseBtn">üñ±Ô∏è –ê–Ω–∞–ª–∏–∑ –¥–≤–∏–∂–µ–Ω–∏–π –º—ã—à–∏</button>
                            <button class="btn btn-primary" id="analyzeFocusBtn">üëÅÔ∏è –ê–Ω–∞–ª–∏–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–π</button>
                            <button class="btn btn-secondary" id="resetFiltersBtn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                    </div>
                    <div id="anomaly-reports"></div>

                    <div class="data-table-container">
					    <div class="table-header">
					        <h2 class="table-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
					        <div class="table-actions">
					            <button class="btn btn-primary" id="exportBtn">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
					        </div>
					    </div>
    
					    <div id="results-container">
					        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
					    </div>
					</div>
					<div id="pagination-container"></div>


                </div> <div id="comparison-view" class="hidden">
                     <div class="comparison-container">
                        <div class="comparison-list-panel">
                            <h3 style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); margin:0;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                            <div class="panel-content" id="comparison-user-list"></div>
                            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border); margin-top: auto;">
                                <button class="btn btn-primary" id="detailedAnalysisBtn" style="width: 100%;" disabled>üî¨ –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑</button>
                                <div style="margin-top: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <input type="checkbox" id="serverAnalysisToggle" style="transform: scale(1.2);"><label for="serverAnalysisToggle" style="font-size: 0.9rem; color: var(--text-light); cursor: pointer;">–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (DTW)</label>
                                </div>
                            </div>
                        </div>
                        <div class="comparison-analysis-panel" id="comparison-results-panel">
                            <div class="comparison-analysis-placeholder"><h4>–ü–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞</h4><p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑".</p></div>
                        </div>
                    </div>
                </div>

                <div id="abandoned-view" class="hidden">
                    <div class="chart-container">
                        <p style="text-align: center; color: var(--text-light); margin-top: -1.5rem; margin-bottom: 1.5rem;">–ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω—ã —Å–µ—Å—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –Ω–∞—á–∞—Ç—ã, –Ω–æ –Ω–µ –±—ã–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –ø–æ–ø—ã—Ç–∫—É –∫—Ä–∞–∂–∏ –≤–æ–ø—Ä–æ—Å–æ–≤.</p>
                        <div class="abandoned-filters" id="abandoned-filters">
                            <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                            <button class="filter-btn" data-filter="test">–¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã</button>
                            <button class="filter-btn" data-filter="study">–¢–æ–ª—å–∫–æ –æ–±—É—á–µ–Ω–∏–µ</button>
                        </div>
                        <div id="abandoned-sessions-container"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π...</div></div>
                    </div>
                </div>

                <div id="behavior-view" class="hidden">
                    <div class="chart-container">
                        <p style="text-align: center; color: var(--text-light); margin-top: -1.5rem; margin-bottom: 1.5rem;">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—è–≤–ª—è–µ—Ç —Ç–µ—Å—Ç—ã, –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —Å –∞–Ω–æ–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.</p>
                        <div id="behavior-analysis-container"><div class="loading">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞...</div></div>
                    </div>
                </div>

                <div id="registry-view" class="hidden">
                    <div class="chart-container">
                        <div id="registry-container"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞...</div></div>
                    </div>
                </div>

                <div id="statistics-view" class="hidden">
                    <div class="stats-overview">
                        <div class="stat-card"><div class="stat-value" id="totalTests">0</div><div class="stat-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div></div>
                        <div class="stat-card"><div class="stat-value" id="averageScore">0%</div><div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div></div>
                        <div class="stat-card"><div class="stat-value" id="anomaliesCount">0</div><div class="stat-label">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∞–Ω–æ–º–∞–ª–∏–π</div></div>
                        <div class="stat-card"><div class="stat-value" id="uniqueUsers">0</div><div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div></div>
                    </div>
                    <div class="chart-container"><h3 class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</h3><canvas id="gradesChart"></canvas></div>
                    <div class="chart-container"><h3 class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h3><canvas id="activityChart"></canvas></div>
                    <div class="chart-container"><h3 class="chart-title">–¢–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∞–Ω–æ–º–∞–ª–∏—è–º</h3><canvas id="anomaliesChart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header"><h3 class="notifications-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3></div>
        <div class="notifications-list" id="notificationsList">
            </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h3><button class="close-btn" id="closeSettingsBtn">&times;</button></div>
            <div style="display: grid; gap: 1rem;">
                <div style="display:flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--light); border-radius: 8px;"><label for="focusThreshold">–ü–æ—Ä–æ–≥ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞:</label><input type="number" id="focusThreshold" class="filter-input" style="width: 80px;"></div>
                <div style="display:flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--light); border-radius: 8px;"><label for="blurThreshold">–ü–æ—Ä–æ–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤–Ω–µ —Ñ–æ–∫—É—Å–∞ (—Å–µ–∫):</label><input type="number" id="blurThreshold" class="filter-input" style="width: 80px;"></div>
                <div style="display:flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--light); border-radius: 8px;"><label for="mouseThreshold">–ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ –º—ã—à–∏ (%):</label><input type="number" id="mouseThreshold" class="filter-input" style="width: 80px;"></div>
                <div style="display:flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--light); border-radius: 8px;"><label for="printThreshold">–ü–æ—Ä–æ–≥ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—á–∞—Ç–∏:</label><input type="number" id="printThreshold" class="filter-input" style="width: 80px;"></div>
                <div style="display:flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--light); border-radius: 8px;"><label for="ipFingerprintCheck">–£—á–∏—Ç—ã–≤–∞—Ç—å IP –≤ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤:</label><input type="checkbox" id="ipFingerprintCheck" style="transform: scale(1.5);"></div>
            </div>
            <div style="margin-top: 1.5rem; text-align: right;"><button class="btn btn-primary" id="saveSettingsBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
    </div>
    <div id="userProfileModal" class="modal">
        <div class="modal-content" style="max-width: 800px;"><div class="modal-header"><h3 class="modal-title" id="profileTitle">üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3><button class="close-btn" id="closeUserProfileBtn">&times;</button></div><div id="profileContent"></div></div>
    </div>
    <div id="eventLogModal" class="modal">
        <div class="modal-content" style="max-width: 800px;"><div class="modal-header"><h3 class="modal-title" id="eventLogTitle">üìú –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h3><button class="close-btn" id="closeEventLogBtn">&times;</button></div><div id="eventLogContent"></div></div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content export-modal">
            <div class="modal-header">
                <h3 class="modal-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                <button class="close-btn" id="closeExportModalBtn">‚úï</button>
            </div>
            <div class="modal-body">
                <h4>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç</h4>
                <div class="export-options">
                    <div class="export-option" data-format="excel">
                        <div class="export-icon">üìä</div>
                        <div class="export-label">Excel</div>
                    </div>
                    <div class="export-option" data-format="pdf">
                        <div class="export-icon">üìÑ</div>
                        <div class="export-label">PDF</div>
                    </div>
                    <div class="export-option" data-format="csv">
                        <div class="export-icon">üìã</div>
                        <div class="export-label">CSV</div>
                    </div>
                </div>
                <div class="export-settings">
                    <div class="export-setting">
                        <span class="export-setting-label">–¢–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏</span>
                        <div class="toggle-switch" id="exportSelectedToggle">
                            <div class="toggle-switch-knob"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExportBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" id="executeExportBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
