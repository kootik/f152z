/**
 * js/state.js
 * * –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã (Single Source of Truth)
 * –¥–ª—è –≤—Å–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ —Ä–∞–∑–¥–µ–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:
 * –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞, —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞.
 * * –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏-—Å–µ—Ç—Ç–µ—Ä—ã –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞,
 * —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –∏ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
 */

// =============================================================================
// –î–ê–ù–ù–´–ï, –ü–û–õ–£–ß–ê–ï–ú–´–ï –° –°–ï–†–í–ï–†–ê
// =============================================================================

/** @type {Array<Object>} –ú–∞—Å—Å–∏–≤ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã. */
export let currentPageResults = [];

/** @type {Array<Object>} –ú–∞—Å—Å–∏–≤ —Å–æ –≤—Å–µ–º–∏ –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏. */
export let allAbandonedSessions = [];

/** @type {Object.<string, {results: Array<Object>, isAnomalous: boolean}>} –ì—Ä—É–ø–ø—ã –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞. */
export let fingerprintGroups = {};

/** @type {Set<string>} –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID –∫–∞—Ä—Ç–æ—á–µ–∫, –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. */
export let selectedForComparison = new Set();

/** @type {Map<string, Object>} –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫—ç—à –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ö–ª—é—á - sessionId. */
export const allLoadedResults = new Map();

export let systemSettings = null;
export let dashboardStats = null;
// =============================================================================
// –°–û–°–¢–û–Ø–ù–ò–ï –ü–ê–ì–ò–ù–ê–¶–ò–ò
// =============================================================================

/** @type {number} –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã. */
export let currentPage = 1;

/** @type {number} –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. */
export let totalResults = 0;

/** @type {number} –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ. */
export let resultsPerPage = 20;


// =============================================================================
// –°–û–°–¢–û–Ø–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
// =============================================================================

/** @type {string} –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–¥–∞ (e.g., 'dashboard'). */
export let currentView = 'dashboard';

/** @type {Object.<string, Chart>} –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ Chart.js –¥–ª—è –∏—Ö –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è. */
export let charts = {};


// =============================================================================
// –ù–ê–°–¢–†–û–ô–ö–ò –ê–ù–ê–õ–ò–ó–ê
// =============================================================================

/** @type {Object} –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–Ω–æ–º–∞–ª–∏–π. */
export let settings = {
    focusThreshold: 5,      // –ú–∞–∫—Å. –∫–æ–ª-–≤–æ –ø–æ—Ç–µ—Ä—å —Ñ–æ–∫—É—Å–∞
    blurThreshold: 60,      // –ú–∞–∫—Å. –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –≤–Ω–µ —Ñ–æ–∫—É—Å–∞
    mouseThreshold: 85,     // –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ –º—ã—à–∏ –≤ % –¥–ª—è DTW
    printThreshold: 0,      // –ú–∞–∫—Å. –∫–æ–ª-–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—á–∞—Ç–∏
    checkIpInFingerprint: true // –£—á–∏—Ç—ã–≤–∞—Ç—å –ª–∏ IP –≤ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤
};


// =============================================================================
// –ö–û–ù–°–¢–ê–ù–¢–´
// =============================================================================

/** @type {Array<string>} –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö. */
export const USER_COLORS = ['#2563eb', '#dc2626', '#059669', '#d97706', '#64748b', '#6d28d9'];


// =============================================================================
// –§–£–ù–ö–¶–ò–ò-–°–ï–¢–¢–ï–†–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø –°–û–°–¢–û–Ø–ù–ò–Ø
// =============================================================================

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –º–∞—Å—Å–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤.
 * @param {Array<Object>} data –ù–æ–≤—ã–π –º–∞—Å—Å–∏–≤ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
 */
export function setCurrentPageResults(data) {
    currentPageResults = data;
    
    // --- üëá –õ–û–ì–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï üëá ---
    // –ö—ç—à (allLoadedResults) –Ω–µ –¥–æ–ª–∂–µ–Ω –æ—á–∏—â–∞—Ç—å—Å—è. 
    // –û–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏,
    // —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (preset filters) —Ä–∞–±–æ—Ç–∞–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
    // allLoadedResults.clear(); // <-- –≠–¢–ê –°–¢–†–û–ö–ê –í–´–ó–´–í–ê–õ–ê –û–®–ò–ë–ö–£ –õ–û–ì–ò–ö–ò
    
    // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–±—â–µ–º –∫—ç—à–µ
    data.forEach(result => {
        if (result.sessionId) {
            allLoadedResults.set(result.sessionId, result);
        }
    });
    // --- üëÜ –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø üëÜ ---
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –º–∞—Å—Å–∏–≤ –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.
 * @param {Array<Object>} data –ù–æ–≤—ã–π –º–∞—Å—Å–∏–≤ —Å —Å–µ—Å—Å–∏—è–º–∏.
 */
export function setAllAbandonedSessions(data) {
    allAbandonedSessions = data;
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç —Å –≥—Ä—É–ø–ø–∞–º–∏ –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤.
 * @param {Object} data –ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –≥—Ä—É–ø–ø.
 */
export function setFingerprintGroups(data) {
    fingerprintGroups = data;
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–¥.
 * @param {string} view –ò–º—è –Ω–æ–≤–æ–≥–æ –≤–∏–¥–∞.
 */
export function setCurrentView(view) {
    currentView = view;
}

/**
 * –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç –æ–±—ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫.
 * @param {Object} newSettings –ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫.
 */
export function setSettings(newSettings) {
    settings = newSettings;
}

/** @type {string} –ö–ª—é—á –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä–µ–µ—Å—Ç—Ä–∞ –∞—Ç—Ç–µ—Å—Ç–∞—Ç–æ–≤. */
export let registrySortKey = 'issue_date';
/** @type {'asc' | 'desc'} –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä–µ–µ—Å—Ç—Ä–∞. */
export let registrySortDir = 'desc';

export function setRegistrySort(key, dir) {
    registrySortKey = key;
    registrySortDir = dir;
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∫—ç—à.
 * @param {Object<string, string>} settings - –û–±—ä–µ–∫—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
 */
export function setSystemSettings(settings) {
    systemSettings = settings;
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
 * @param {Object} partialSettings –û–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
 */
export function updateSettings(partialSettings) {
    settings = { ...settings, ...partialSettings };
}


/** @type {string} The key by which the abandoned sessions table is sorted. */
export let abandonedSessionsSortKey = 'startTime';
/** @type {'asc' | 'desc'} The direction of the sort. */
export let abandonedSessionsSortDir = 'desc';


export function setAbandonedSessionsSort(key, dir) {
    abandonedSessionsSortKey = key;
    abandonedSessionsSortDir = dir;
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
 * @param {number} page –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
 * @param {number} perPage –≠–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
 * @param {number} total –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
 */
export function setPaginationState(page, perPage, total) {
    currentPage = page;
    resultsPerPage = perPage;
    totalResults = total;
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
 * @param {number|string} count - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.
 */
export function setResultsPerPage(count) {
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
    // –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è MAX_RESULTS_PER_PAGE –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
    const maxLimit = 999; 
    resultsPerPage = count === 'all' ? maxLimit : parseInt(count, 10);
}


/** @type {string} –ö–ª—é—á –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. */
export let mainResultsSortKey = 'startTime';
/** @type {'asc' | 'desc'} –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏. */
export let mainResultsSortDir = 'desc';


export function setMainResultsSort(key, dir) {
    mainResultsSortKey = key;
    mainResultsSortDir = dir;
}
export function setDashboardStats(stats) {
    dashboardStats = stats;
}

// --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –õ–∏—à–Ω—è—è '}' –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞ –£–î–ê–õ–ï–ù–ê ---